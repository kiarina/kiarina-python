name: Dependency Update

on:
  schedule:
    # Run every Monday at 9:00 AM UTC (6:00 PM JST in standard time, 7:00 PM JST in daylight saving time)
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      falkordb:
        image: falkordb/falkordb:latest
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli -p 6379 ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install mise
      uses: jdx/mise-action@v3
      with:
        version: 2025.9.6
        cache: true
        install: false

    - name: Setup development environment
      run: mise run setup

    - name: Update dependencies
      id: update
      run: |
        echo "Updating dependencies..."
        uv sync --upgrade --all-groups --all-extras --all-packages

        # Check if there are any changes
        if git diff --quiet uv.lock; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No dependency updates available"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Dependencies updated"
        fi

    - name: Run comprehensive CI checks
      if: steps.update.outputs.has_changes == 'true'
      run: mise run ci --no-setup --no-docker

    - name: Create Pull Request
      if: steps.update.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update dependencies"
        title: "chore: update dependencies"
        body: |
          ## Dependency Update

          This PR updates project dependencies to their latest versions.

          ### Changes
          - Updated all dependencies via `uv sync --upgrade`
          - Updated lock file

          ### Testing
          - ✅ All tests pass with updated dependencies
          - ✅ All CI checks pass

          ### Auto-generated
          This PR was automatically created by GitHub Actions.
          
          **Review the changes and merge when ready.**
        branch: chore/update-dependencies-${{ github.run_number }}
        delete-branch: true
        assignees: kiarina
        reviewers: kiarina
        labels: |
          dependencies
          automated
