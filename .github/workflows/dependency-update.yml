name: Dependency Update

on:
  schedule:
    # Run every day at 9:00 PM UTC (6:00 AM JST)
    - cron: '0 21 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      falkordb:
        image: falkordb/falkordb:latest
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli -p 6379 ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install mise
      uses: jdx/mise-action@v3
      with:
        version: 2025.9.6
        cache: true
        install: false

    - name: Setup development environment
      run: mise run setup
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Update dependencies
      id: update
      run: |
        echo "Updating dependencies..."
        uv sync --upgrade --all-groups --all-extras --all-packages

        # Check if there are any changes
        if git diff --quiet uv.lock; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No dependency updates available"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Dependencies updated"
        fi

    - name: Check for existing PR
      if: steps.update.outputs.has_changes == 'true'
      id: check_pr
      run: |
        # Check if there's already an open PR for dependency updates
        EXISTING_PR=$(gh pr list --state open --label "dependencies" --label "automated" --json number,title --jq '.[0].number // ""')
        
        if [ -n "$EXISTING_PR" ]; then
          echo "existing_pr=$EXISTING_PR" >> $GITHUB_OUTPUT
          echo "Found existing PR #$EXISTING_PR"
        else
          echo "existing_pr=" >> $GITHUB_OUTPUT
          echo "No existing PR found"
        fi
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run comprehensive CI checks
      if: steps.update.outputs.has_changes == 'true' && steps.check_pr.outputs.existing_pr == ''
      run: mise run ci --no-setup --no-docker
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Create Pull Request
      if: steps.update.outputs.has_changes == 'true' && steps.check_pr.outputs.existing_pr == ''
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update dependencies"
        title: "chore: update dependencies"
        body: |
          ## Dependency Update

          This PR updates project dependencies to their latest versions.

          ### Changes
          - Updated all dependencies via `uv sync --upgrade`
          - Updated lock file

          ### Testing
          - ✅ All tests pass with updated dependencies
          - ✅ All CI checks pass

          ### Auto-generated
          This PR was automatically created by GitHub Actions.
          
          **Review the changes and merge when ready.**
        branch: chore/update-dependencies
        delete-branch: true
        assignees: kiarina
        reviewers: kiarina
        labels: |
          dependencies
          automated

    - name: Skip PR creation (existing PR found)
      if: steps.update.outputs.has_changes == 'true' && steps.check_pr.outputs.existing_pr != ''
      run: |
        echo "⏭️ Skipping PR creation - existing PR #${{ steps.check_pr.outputs.existing_pr }} is still open"
        echo "Please review and merge the existing PR before creating a new one."
        echo ""
        echo "View existing PR: ${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.check_pr.outputs.existing_pr }}"
