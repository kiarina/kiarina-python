#!/usr/bin/env bash
#MISE description="Test *"
#USAGE flag "-c --coverage" help="Run with coverage"
#USAGE flag "--no-docker" help="Skip Docker Compose up/down"

set -euo pipefail

# Default values for optional flags
coverage="${usage_coverage:-false}"
no_docker="${usage_no_docker:-false}"

if [ "$no_docker" = "false" ]; then
    echo "ğŸ³ Starting Docker services..."
    docker compose up -d
fi

# Clean previous coverage data
if [ "$coverage" = "true" ]; then
    echo "ğŸ§¹ Cleaning previous coverage data..."
    rm -f .coverage .coverage.*
fi

for package in packages/*/; do
    if [ "$coverage" = "true" ]; then
        mise run package:test $(basename "$package") --coverage
    else
        mise run package:test $(basename "$package")
    fi
done

# Generate coverage reports
if [ "$coverage" = "true" ]; then
    echo ""
    echo "ğŸ“Š Generating coverage reports..."
    
    echo "ğŸ“‹ Generating coverage report..."
    uv run --group test coverage report
    
    echo "ğŸ“„ Generating XML coverage report..."
    uv run --group test coverage xml
    
    echo "âœ… Coverage reports generated:"
    echo "   - Terminal report: shown above"
    echo "   - XML report: coverage.xml"
fi

if [ "$no_docker" = "false" ]; then
    echo "ğŸ³ Stopping Docker services..."
    docker compose down
fi
